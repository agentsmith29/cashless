{% extends "./sidebar/sidebar.html" %}
{% load static %}
{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Add New Customer</h1>
    <form id="addCustomerForm" method="post" class="border p-4 shadow-sm bg-light">
        {% csrf_token %}
        <div class="form-group">
            <label for="name">First Name</label>
            <input type="text" class="form-control" id="name" name="name" required>
        </div>
        <div class="form-group">
            <label for="surname">Last Name</label>
            <input type="text" class="form-control" id="surname" name="surname" required>
        </div>
        <div class="form-group">
            <label for="balance">Initial Balance (€)</label>
            <input type="number" class="form-control" id="balance" name="balance" step="0.01" required>
        </div>
        <button type="submit" class="btn btn-success">Add Customer</button>
    </form>
</div>

<div class="container mt-5">
    <h1 class="mb-4">Customer List</h1>
    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Card Number</th>
                    <th>Name</th>
                    <th>Surname</th>
                    <th>Issued At</th>
                    <th>Balance (€)</th>
                </tr>
            </thead>
            <tbody>
                {% for customer in customers %}
                <tr>
                    <td>{{ customer.card_number }}</td>
                    <td>{{ customer.name }}</td>
                    <td>{{ customer.surname }}</td>
                    <td>{{ customer.issued_at }}</td>
                    <td>{{ customer.balance }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">No customers available.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- NFC Overlay -->
<div id="nfcOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 9999; color: white; text-align: center; padding-top: 20%;">
    <div>
        <img src="{% static 'images/nfc-scan.png' %}" alt="NFC Scan" style="width: 150px;">
        <p>Scan your card to proceed...</p>
    </div>
</div>

<script>
    document.getElementById('addCustomerForm').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent form submission
        const overlay = document.getElementById('nfcOverlay');
        overlay.style.display = 'block'; // Show NFC overlay

        // Make a POST request to trigger the NFC reader
        fetch("{% url 'customers' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': "{{ csrf_token }}",
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: document.getElementById('name').value,
                surname: document.getElementById('surname').value,
                balance: document.getElementById('balance').value
            })
        }).then(response => {
            if (response.ok) {
                location.reload(); // Reload the page after success
            } else {
                alert('Error occurred. Please try again.');
            }
        }).finally(() => {
            overlay.style.display = 'none'; // Hide NFC overlay
        });
    });
</script>
{% endblock %}
